generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Chain {
  id            Int            @id @default(autoincrement())
  chainId       Int            @unique @map("chain_id")
  name          String
  rpcUrl        String         @map("rpc_url")
  type          String
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  blocks        Block[]
  contracts     Contract[]
  indexedEvents IndexedEvent[]
  rawEvents     RawEvent[]

  @@map("chains")
}

model Block {
  id          Int      @id @default(autoincrement())
  chainId     Int      @map("chain_id")
  number      BigInt   @map("block_number")
  hash        String   @db.VarChar(66)
  parentHash  String   @map("parent_hash") @db.VarChar(66)
  timestamp   DateTime
  isCanonical Boolean  @default(true) @map("is_canonical")
  createdAt   DateTime @default(now()) @map("created_at")
  chain       Chain    @relation(fields: [chainId], references: [chainId])

  @@unique([chainId, number])
  @@unique([chainId, hash])
  @@index([timestamp])
  @@map("blocks")
}

model Contract {
  id        Int      @id @default(autoincrement())
  chainId   Int      @map("chain_id")
  address   String   @db.VarChar(42)
  type      String?
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  chain     Chain    @relation(fields: [chainId], references: [chainId])

  @@unique([chainId, address])
  @@map("contracts")
}

model RawEvent {
  id             BigInt   @id @default(autoincrement())
  chainId        Int      @map("chain_id")
  blockNumber    BigInt   @map("block_number")
  txHash         String   @map("tx_hash") @db.VarChar(66)
  logIndex       Int      @map("log_index")
  eventSignature String?  @map("event_signature")
  data           Json
  createdAt      DateTime @default(now()) @map("created_at")
  chain          Chain    @relation(fields: [chainId], references: [chainId])

  @@unique([chainId, txHash, logIndex])
  @@index([chainId, blockNumber])
  @@map("raw_events")
}

model IndexedEvent {
  id                   BigInt   @id @default(autoincrement())
  chainId              Int      @map("chain_id")
  blockNumber          BigInt   @map("block_number")
  txHash               String   @map("tx_hash") @db.VarChar(66)
  logIndex             Int      @map("log_index")
  eventType            String   @map("event_type")
  contractAddress      String   @map("contract_address")
  from                 String?  @db.VarChar(42)
  to                   String?  @db.VarChar(42)
  value                String?
  tokenId              String?  @map("token_id")
  amount               String?
  metadata             Json?
  timestamp            DateTime
  isCanonical          Boolean  @default(true) @map("is_canonical")
  version              Int      @default(1)
  createdAt            DateTime @default(now()) @map("created_at")
  effectiveGasPrice    String?  @map("effective_gas_price")
  gasPrice             String?  @map("gas_price")
  gasUsed              String?  @map("gas_used")
  gasLimit             String?  @map("gas_limit")
  input                String?  @db.LongText
  maxFeePerGas         String?  @map("max_fee_per_gas")
  maxPriorityFeePerGas String?  @map("max_priority_fee_per_gas")
  nonce                Int?
  transactionIndex     Int?     @map("transaction_index")
  txType               Int?     @map("tx_type")
  chain                Chain    @relation(fields: [chainId], references: [chainId])

  @@unique([chainId, txHash, logIndex, version])
  @@index([chainId, eventType, timestamp])
  @@index([timestamp])
  @@index([from])
  @@index([to])
  @@map("indexed_events")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String?
  role      String   @default("user")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  apiKeys   ApiKey[]

  @@map("users")
}

model ApiKey {
  id         String    @id @default(uuid())
  key        String    @unique
  userId     String    @map("user_id")
  name       String?
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")
  user       User      @relation(fields: [userId], references: [id])

  @@index([key])
  @@index([userId], map: "api_keys_user_id_fkey")
  @@map("api_keys")
}

model ErrorLog {
  id              BigInt   @id @default(autoincrement())
  chainId         Int?     @map("chain_id")
  errorType       String   @map("error_type") // 'RPC_ERROR', 'WEBSOCKET_ERROR', 'DATABASE_ERROR', 'PROCESSING_ERROR', etc.
  errorSource     String   @map("error_source") // Service name: 'ingestion-service', 'indexer-worker', 'query-api', etc.
  errorMessage    String   @map("error_message") @db.Text
  stackTrace      String?  @map("stack_trace") @db.Text
  context         Json?    // Additional context like block number, transaction hash, RPC endpoint, etc.
  severity        String   @default("ERROR") // 'INFO', 'WARNING', 'ERROR', 'CRITICAL'
  isResolved      Boolean  @default(false) @map("is_resolved")
  retryCount      Int      @default(0) @map("retry_count")
  createdAt       DateTime @default(now()) @map("created_at")
  resolvedAt      DateTime? @map("resolved_at")

  @@index([errorType])
  @@index([errorSource])
  @@index([chainId])
  @@index([createdAt])
  @@index([severity])
  @@map("error_logs")
}
